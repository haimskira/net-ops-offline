<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rule Manager Pro</title>
    <style>
        /* 
         * NO EXTERNAL DEPENDENCIES
         * Design System: "Environment Config" 
         */
        :root {
            /* Palette - Dark Mode (Default) */
            --bg-primary: #020617;
            /* Deepest Navy */
            --bg-panel: #0f172a;
            /* Panel Navy */
            --bg-input: #1e293b;
            /* Slate Blue Input */
            --text-main: #f8fafc;
            /* White-ish */
            --text-muted: #94a3b8;
            /* Muted Slate */
            --accent-color: #06b6d4;
            /* Neon Cyan */
            --accent-hover: #0891b2;
            --border-color: #334155;
            /* Subtle Border */
            --success-color: #10b981;
            --danger-color: #ef4444;
            --input-height: 48px;
            --radius-md: 6px;
        }

        /* Light Mode Variables */
        body.light-mode {
            --bg-primary: #f1f5f9;
            --bg-panel: #ffffff;
            --bg-input: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border-color: #cbd5e1;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-main);
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 40px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Layout Grid --- */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            width: 100%;
        }

        /* --- Header --- */
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .header-icon {
            width: 48px;
            height: 48px;
            background: rgba(6, 182, 212, 0.15);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1.5rem;
            color: var(--accent-color);
        }

        .header-icon svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .header-info h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 4px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .header-info p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-family: monospace;
        }

        /* Theme Toggle Removed - Controlled by Navbar */

        /* --- Main Panel --- */
        .config-panel {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
        }

        /* --- Identity Row --- */
        .identity-row {
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            /* EQUAL COLUMNS as requested */
            gap: 2rem;
            align-items: end;
        }

        /* --- Traffic Grid --- */
        .traffic-engine {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
        }

        .engine-col {
            padding: 2rem;
            border-right: 1px solid var(--border-color);
        }

        .engine-col:last-child {
            border-right: none;
        }

        .col-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent-color);
        }

        .col-header svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .col-header.logic {
            color: #a5b4fc;
        }

        .col-header.dst {
            color: var(--success-color);
        }

        /* --- Inputs --- */
        .input-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .input-group:last-child {
            margin-bottom: 0;
        }

        /* Fix for Grid Alignment: Override margin for identity row items */
        .identity-row .input-group {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-family: monospace;
        }

        input {
            width: 100%;
            height: var(--input-height);
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-main);
            padding: 0 1rem;
            font-family: system-ui, monospace;
            font-size: 0.95rem;
            appearance: none;
            outline: none;
            transition: all 0.2s;
        }

        input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 1px var(--accent-color);
        }

        input::placeholder {
            color: var(--text-muted);
            opacity: 0.5;
        }

        /* --- Custom Dropdowns --- */
        select.hidden-native,
        select.custom-enabled {
            display: none;
        }

        .custom-select {
            position: relative;
            user-select: none;
            width: 100%;
            height: var(--input-height);
        }

        .select-trigger {
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .select-trigger:hover {
            border-color: var(--text-muted);
        }

        .select-trigger span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .select-arrow {
            width: 12px;
            height: 12px;
            margin-left: 10px;
            fill: var(--accent-color);
            opacity: 0.8;
            transition: transform 0.2s;
        }

        .custom-select.open .select-arrow {
            transform: rotate(180deg);
        }

        .custom-select.open .select-trigger {
            border-color: var(--accent-color);
        }

        .select-options {
            position: absolute;
            top: 105%;
            left: 0;
            right: 0;
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            z-index: 100;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .custom-select.open .select-options {
            display: block;
        }

        .select-option {
            padding: 10px 1rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.9rem;
        }

        .select-option:hover {
            background-color: rgba(6, 182, 212, 0.1);
            color: var(--accent-color);
        }

        .select-option.selected {
            color: var(--accent-color);
            font-weight: bold;
        }

        /* --- Footer --- */
        .footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border-color);
            /* Default Dark Mode: Darker than panel */
            background-color: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: flex-end;
            align-items: center;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .light-mode .footer {
            /* Light Mode: Distinct grey background (Slate-100/200) */
            background-color: var(--bg-input);
            border-top-color: var(--border-color);
        }

        .btn-submit {
            background-color: var(--accent-color);
            color: #0b1120;
            border: none;
            height: var(--input-height);
            padding: 0 2rem;
            border-radius: var(--radius-md);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .btn-submit:hover {
            background-color: var(--accent-hover);
        }

        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-submit svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        /* --- Utilities --- */
        .badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid;
            font-family: monospace;
            margin-left: 8px;
        }

        .badge-auto {
            color: #a5b4fc;
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }

        .hidden {
            display: none !important;
        }

        /* Alerts */
        .alert-box {
            padding: 1rem;
            margin: 0 2rem 1rem 2rem;
            border: 1px solid;
            border-radius: var(--radius-md);
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .alert-box.danger {
            border-color: var(--danger-color);
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
        }

        .alert-box.success {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.1);
            color: #34d399;
        }

        .alert-box svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        /* Spinner */
        #loader {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-family: monospace;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .spin-circle {
            width: 12px;
            height: 12px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Autocomplete Results */
        .live-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            z-index: 200;
            max-height: 200px;
            overflow-y: auto;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        }

        .res-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .res-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--accent-color);
        }
    </style>
</head>

<body>

    <div class="container">
        <header class="header">
            <div class="header-icon">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M7.5 5.6L10 7 8.6 4.5 10 2 7.5 3.4 5 2 6.4 4.5 5 7zM19 2l-2.5 1.4L14 2l1.4 2.5L14 7l2.5-1.4L19 7l-1.4-2.5zm-5.6 5.6L11 2.5 8.4 7.6 3.3 10.2l5.1 2.6L11 17.9l2.6-5.1 5.1-2.6z" />
                </svg>
            </div>
            <div class="header-info">
                <h1>Rule Manager Pro</h1>
            </div>
            <!-- Theme Toggle Removed -->
            <div id="loader" class="hidden" style="margin-left: auto;">
                <div class="spin-circle"></div> CONNECTING...
            </div>
        </header>

        <div class="config-panel">
            <!-- Identity -->
            <div class="identity-row">

                <div class="input-group">
                    <label>Tag</label>
                    <select id="tag" class="custom-enabled"></select>
                </div>
                <div class="input-group">
                    <label>Group Tag</label>
                    <select id="group_tag" class="custom-enabled"></select>
                </div>
            </div>

            <div id="shadow-container" class="hidden" style="padding-top: 2rem;">
                <div id="shadow-box" class="alert-box"></div>
            </div>

            <!-- Traffic -->
            <div class="traffic-engine">
                <!-- Source -->
                <div class="engine-col">
                    <div class="col-header">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M2.5 19h19v2h-19zm19.57-9.36c-.21-.8-1.04-1.28-1.84-1.06L14.92 10l-6.9-6.43-1.93.51 4.14 7.17-4.97 1.33-1.97-1.54-1.45.39 1.82 3.16.77 1.33 16.02-4.3c.8-.21 1.28-1.05 1.07-1.85z" />
                        </svg>
                        Source Definition
                    </div>

                    <div class="input-group">
                        <label>From Zone <span id="src-zone-status" class="badge badge-auto hidden">AUTO</span></label>
                        <select id="from_zone" class="hidden-native custom-enabled"></select>
                    </div>

                    <div class="input-group">
                        <label>Source Address</label>
                        <input id="source_ip" placeholder="IP / Object..." autocomplete="off"
                            oninput="handleInputProcessing(this, 'src')">
                        <div id="src_results" class="live-results hidden"></div>
                    </div>

                    <div class="input-group">
                        <label>Source Group</label>
                        <select id="source_group" class="hidden-native custom-enabled"
                            onchange="handleMutualExclusion('source_group', 'source_ip')">
                            <option value="">Select Group...</option>
                        </select>
                    </div>
                </div>

                <!-- Logic -->
                <div class="engine-col">
                    <div class="col-header logic">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
                        </svg>
                        Traffic Logic
                    </div>

                    <div class="input-group">
                        <label>Application</label>
                        <input id="application" value="any" autocomplete="off"
                            oninput="handleLiveSearch(this, 'app', fwAppList)">
                        <div id="app_results" class="live-results hidden"></div>
                    </div>

                    <div class="input-group">
                        <label>Service / Port</label>
                        <input id="service_port" value="application-default" autocomplete="off"
                            oninput="handleLiveSearch(this, 'service', fwServiceList)">
                        <div id="service_results" class="live-results hidden"></div>
                    </div>
                </div>

                <!-- Dest -->
                <div class="engine-col">
                    <div class="col-header dst">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M22 9V7h-2V5c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-2h2v-2h-2v-2h2v-2h-2V9h2zm-4 10H4V5h14v14zM6 13h5v4H6zm6-6h4v3h-4zM6 7h5v5H6zm6 4h4v6h-4z" />
                        </svg>
                        Destination
                    </div>

                    <div class="input-group">
                        <label>To Zone <span id="dst-zone-status" class="badge badge-auto hidden">AUTO</span></label>
                        <select id="to_zone" class="hidden-native custom-enabled"></select>
                    </div>

                    <div class="input-group">
                        <label>Destination Address</label>
                        <input id="destination_ip" placeholder="IP / Object..." autocomplete="off"
                            oninput="handleInputProcessing(this, 'dst')">
                        <div id="dst_results" class="live-results hidden"></div>
                    </div>

                    <div class="input-group">
                        <label>Destination Group</label>
                        <select id="destination_group" class="hidden-native custom-enabled"
                            onchange="handleMutualExclusion('destination_group', 'destination_ip')">
                            <option value="">Select Group...</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="footer">
                <div id="status-msg" style="margin-right: 1.5rem; font-weight: 700; color: var(--accent-color);"
                    class="hidden"></div>
                <button id="submit-btn" class="btn-submit" onclick="submitAction('/create-rule')">
                    SUBMIT CONFIG
                    <svg viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        /* --- Pure JS Custom Dropdowns --- */
        function initCustomDropdowns() {
            document.querySelectorAll('select.custom-enabled').forEach(native => {
                if (native.nextElementSibling && native.nextElementSibling.classList.contains('custom-select')) native.nextElementSibling.remove();

                const wrapper = document.createElement('div'); wrapper.className = 'custom-select';
                const trigger = document.createElement('div'); trigger.className = 'select-trigger';
                const label = native.options[native.selectedIndex]?.text || "Select...";
                trigger.innerHTML = `<span>${label}</span><svg class="select-arrow" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>`;

                const options = document.createElement('div'); options.className = 'select-options';
                Array.from(native.options).forEach(opt => {
                    const item = document.createElement('div'); item.className = 'select-option';
                    item.textContent = opt.text; item.dataset.value = opt.value;
                    if (opt.selected) item.classList.add('selected');
                    item.onclick = (e) => {
                        e.stopPropagation();
                        native.value = opt.value;
                        native.dispatchEvent(new Event('change'));
                        trigger.querySelector('span').textContent = opt.text;
                        wrapper.classList.remove('open');
                        options.querySelectorAll('.select-option').forEach(el => el.classList.remove('selected'));
                        item.classList.add('selected');
                    };
                    options.appendChild(item);
                });

                trigger.onclick = (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.custom-select').forEach(c => { if (c !== wrapper) c.classList.remove('open'); });
                    wrapper.classList.toggle('open');
                };

                wrapper.appendChild(trigger); wrapper.appendChild(options);
                native.parentNode.insertBefore(wrapper, native.nextSibling);

                native.addEventListener('change', () => {
                    const newLabel = native.options[native.selectedIndex]?.text;
                    if (newLabel) trigger.querySelector('span').textContent = newLabel;
                });
            });

            document.addEventListener('click', () => document.querySelectorAll('.custom-select').forEach(c => c.classList.remove('open')));
        }

        /* --- Theme Sync Logic --- */
        function syncTheme() {
            const theme = localStorage.getItem('theme');
            if (theme === 'light') document.body.classList.add('light-mode');
            else document.body.classList.remove('light-mode');
        }
        window.addEventListener('storage', syncTheme);
        window.addEventListener('message', (event) => {
            if (event.data === 'theme-toggle' || event.data.type === 'theme-toggle') document.body.classList.toggle('light-mode');
            else if (event.data.type === 'set-theme') {
                if (event.data.theme === 'light') document.body.classList.add('light-mode');
                else document.body.classList.remove('light-mode');
            }
            else if (event.data.type === 'FILL_RULE' && event.data.data) {
                // Fill form from traffic log entry
                const log = event.data.data;
                console.log('ðŸ“‹ FILL_RULE received:', log);

                // Wait for params to load
                paramsPromise.then(() => {
                    console.log('âœ… Params loaded, filling form...');

                    // Fill zones (these are select dropdowns)
                    if (log.src_zone) {
                        setDropdownValue('from_zone', log.src_zone);
                        console.log('Set from_zone:', log.src_zone);
                    }
                    if (log.dst_zone) {
                        setDropdownValue('to_zone', log.dst_zone);
                        console.log('Set to_zone:', log.dst_zone);
                    }

                    // Fill IPs (these are text inputs, not dropdowns!)
                    if (log.source) {
                        document.getElementById('source_ip').value = log.source;
                        console.log('Set source_ip:', log.source);
                    }
                    if (log.destination) {
                        document.getElementById('destination_ip').value = log.destination;
                        console.log('Set destination_ip:', log.destination);
                    }

                    // Fill application
                    if (log.app && log.app !== 'insufficient-data') {
                        document.getElementById('application').value = log.app;
                        console.log('Set application:', log.app);
                    }

                    // Fill service/port - Backend expects port number only (e.g., "443"), not "443/UDP"
                    if (log.dst_port) {
                        document.getElementById('service_port').value = log.dst_port;
                        console.log('Set service_port:', log.dst_port);
                    }

                    console.log('âœ… Form filled successfully from traffic log');
                });
            }
        });

        // Helper function to set dropdown value if exists
        function setDropdownValue(selectId, value) {
            const select = document.getElementById(selectId);
            if (!select) {
                console.warn(`Dropdown not found: ${selectId}`);
                return;
            }

            // Check if value exists in options
            const option = Array.from(select.options).find(opt => opt.value === value);
            if (option) {
                select.value = value;
                console.log(`âœ“ Dropdown ${selectId} set to existing value:`, value);
            } else {
                // Add as first option if not found
                const newOption = new Option(value, value);
                select.add(newOption, 0);
                select.value = value;
                console.log(`âŠ• Dropdown ${selectId} added new option and set to:`, value);
            }
        }
        syncTheme();

        /* --- Application Logic --- */
        let fwObjectMap = {};
        let fwAppList = [];
        let fwServiceList = [];
        let fwTagList = [];
        let fwGroupTagList = [];
        let isShadowBlocked = false;
        let shadowCheckTimeout;
        let resolveParams; const paramsPromise = new Promise(r => resolveParams = r);

        async function fetchParams() {
            document.getElementById('loader').classList.remove('hidden');
            try {
                const res = await fetch('/get-params');
                const data = await res.json();
                if (data.status === 'success') {
                    fwObjectMap = data.address_map || {};

                    // DATA SOURCE: Ensuring we get the full list
                    fwAppList = data.applications || ["any"];
                    fwServiceList = data.services || ["any", "application-default"];

                    // Tag: Must NOT start with Number or 'G-'
                    fwTagList = ["None", ...(data.tags || []).filter(t => !/^(\d|g-)/i.test(t))];
                    // Group Tag: Must start with Number or 'G-'
                    fwGroupTagList = ["Select...", ...(data.tags || []).filter(t => /^(\d|g-)/i.test(t))];

                    const populate = (id, items) => {
                        const el = document.getElementById(id); if (!el) return;
                        el.innerHTML = id.includes('group') ? '<option value="">Select Group...</option>' : '';
                        let arr = [...items];
                        if (id.includes('zone') && !arr.includes('any')) arr.unshift('any');
                        arr.forEach(i => el.add(new Option(i, i)));
                        if (id === 'from_zone' || id === 'to_zone') el.value = 'any';
                    };

                    populate('from_zone', data.zones);
                    populate('to_zone', data.zones);
                    populate('source_group', data.address_groups);
                    populate('destination_group', data.address_groups);
                    populate('tag', fwTagList);
                    populate('group_tag', fwGroupTagList || []);

                    initCustomDropdowns();
                    document.getElementById('loader').classList.add('hidden');
                    resolveParams();
                }
            } catch (e) { console.error(e); }
        }

        function handleLiveSearch(input, type, source) {
            const query = input.value.toLowerCase().trim();
            const box = document.getElementById(`${type}_results`);
            box.innerHTML = "";

            // SHOW ALL if empty and type is a searchable list
            if (!query && !['app', 'service', 'tag', 'group_tag'].includes(type)) { box.classList.add('hidden'); return; }

            let matches = [];
            if (Array.isArray(source)) {
                // SEARCH LOGIC: If query exists, filter. If not, show all (sliced to 500 for performance)
                if (query) {
                    matches = source.filter(s => s.toLowerCase().includes(query)).slice(0, 5000);
                } else {
                    matches = source.slice(0, 5000); // Show up to 5000 items if no query
                }
            } else {
                matches = Object.entries(source).filter(([k, v]) => k.toLowerCase().includes(query) || (v && v.includes(query))).slice(0, 20);
            }

            if (!matches.length) { box.classList.add('hidden'); return; }

            matches.forEach(m => {
                const div = document.createElement('div'); div.className = 'res-item';
                if (Array.isArray(source)) {
                    div.textContent = m;
                    div.onmousedown = () => { input.value = m; box.classList.add('hidden'); triggerShadowCheck(); };
                } else {
                    div.innerHTML = `<b>${m[0]}</b> <small>${m[1] || ''}</small>`;
                    div.onmousedown = () => {
                        input.value = m[0]; box.classList.add('hidden');
                        handleMutualExclusion(input.id, type === 'src' ? 'source_group' : 'destination_group');
                        runAutoZoneDetection(m[0], type);
                        triggerShadowCheck();
                    };
                }
                box.appendChild(div);
            });
            box.classList.remove('hidden');
        }

        function handleInputProcessing(input, type) {
            handleLiveSearch(input, type, fwObjectMap);
            handleMutualExclusion(input.id, type === 'src' ? 'source_group' : 'destination_group');
            clearTimeout(input.zoneTimeout);
            input.zoneTimeout = setTimeout(() => runAutoZoneDetection(input.value, type), 600);
            triggerShadowCheck();
        }

        async function runAutoZoneDetection(val, type) {
            if (!val || val === 'any' || val.length < 3) return;
            try {
                const res = await fetch(`/api/detect-zone?ip=${encodeURIComponent(val)}`);
                const data = await res.json();
                if (data.status === 'success' && data.zone) {
                    const el = document.getElementById(type === 'src' ? 'from_zone' : 'to_zone');
                    el.value = data.zone;
                    el.dispatchEvent(new Event('change'));
                    document.getElementById(`${type}-zone-status`).classList.remove('hidden');
                    triggerShadowCheck();
                }
            } catch (e) { }
        }

        function triggerShadowCheck() {
            clearTimeout(shadowCheckTimeout); shadowCheckTimeout = setTimeout(runShadowCheck, 500);
        }

        async function runShadowCheck() {
            const srcRaw = document.getElementById('source_ip').value || document.getElementById('source_group').value;
            const dstRaw = document.getElementById('destination_ip').value || document.getElementById('destination_group').value;

            const cont = document.getElementById('shadow-container');
            const btn = document.getElementById('submit-btn');

            // User Requirement: Don't check unless BOTH Source and Destination are provided
            if (!srcRaw || !dstRaw) {
                cont.classList.add('hidden'); isShadowBlocked = false; btn.disabled = false;
                return;
            }

            const src = srcRaw || 'any';
            const dst = dstRaw || 'any';

            const data = {
                source_ip: src, destination_ip: dst,
                service_port: document.getElementById('service_port').value,
                application: document.getElementById('application').value || 'any',
                from_zone: document.getElementById('from_zone').value,
                to_zone: document.getElementById('to_zone').value
            };

            try {
                const res = await fetch('/check-shadow', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                const r = await res.json();
                const box = document.getElementById('shadow-box');
                const cont = document.getElementById('shadow-container');
                const btn = document.getElementById('submit-btn');

                if (r.status === 'shadowed') {
                    cont.classList.remove('hidden'); isShadowBlocked = true; btn.disabled = true;
                    const isDeny = (r.action || '').toLowerCase() === 'deny';
                    box.className = `alert-box ${isDeny ? 'danger' : 'success'}`;
                    box.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                <div><strong>SHADOW CONFLICT: ${r.rules[0]}</strong><div style="font-size:0.8rem">Effective Action: ${r.action.toUpperCase()}</div></div>`;
                } else {
                    cont.classList.add('hidden'); isShadowBlocked = false; btn.disabled = false;
                }
            } catch (e) { }
        }

        function handleMutualExclusion(actId, inactId) {
            const act = document.getElementById(actId); const inact = document.getElementById(inactId);
            if (act.value) { inact.disabled = true; inact.value = ""; inact.placeholder = "LOCKED"; }
            else { inact.disabled = false; inact.placeholder = "Input..."; }
        }

        async function submitAction(ep) {
            if (isShadowBlocked) return;

            // Auto-Generate Name Logic
            const src = document.getElementById('source_ip').value || document.getElementById('source_group').value || 'any';
            const dst = document.getElementById('destination_ip').value || document.getElementById('destination_group').value || 'any';
            const app = document.getElementById('application').value || 'any';
            const svc = document.getElementById('service_port').value || 'application-default';

            // Format: [src] to [dst] in [port|app]
            // SANITIZATION FIX: Pydantic expects ^[A-Za-z0-9 _\-]+$
            // Replace dots, slashes, and other special chars with underscores
            const connector = (svc === 'application-default' || svc === 'any') ? app : svc;
            const safeSrc = src.replace(/[^a-zA-Z0-9_\-]/g, '_');
            const safeDst = dst.replace(/[^a-zA-Z0-9_\-]/g, '_');
            const safeConnector = connector.replace(/[^a-zA-Z0-9_\-]/g, '_');

            const autoName = `${safeSrc}_to_${safeDst}_in_${safeConnector}`;

            const status = document.getElementById('status-msg');
            status.textContent = "TRANSMITTING..."; status.classList.remove('hidden'); status.style.color = 'var(--text-muted)';

            // Clean service port (remove /UDP, /TCP) for backend validation
            const cleanSvc = svc.replace(/\/.*/, '');

            const data = {
                rule_name: autoName,
                source_ip: src,
                destination_ip: dst,
                application: app,
                service_port: cleanSvc,
                from_zone: document.getElementById('from_zone').value, to_zone: document.getElementById('to_zone').value,
                tag: document.getElementById('tag').value || 'None', group_tag: document.getElementById('group_tag').value
            };

            try {
                const res = await fetch(ep, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                const r = await res.json();
                status.textContent = r.message.toUpperCase();
                status.style.color = r.status === 'success' ? 'var(--success-color)' : 'var(--danger-color)';
                if (r.status === 'success') setTimeout(() => location.reload(), 5000);
            } catch (e) { status.textContent = "COMMUNICATION FAILURE"; status.style.color = 'var(--danger-color)'; }
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.live-results')) document.querySelectorAll('.live-results').forEach(el => el.classList.add('hidden'));
        });

        window.onload = fetchParams;
    </script>
</body>

</html>
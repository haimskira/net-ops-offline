<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <title>NetOps Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/glass-theme.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fontawesome.all.min.css') }}">
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
    <style>
        body {
            background-color: var(--bg-darker);
            color: var(--text-primary);
            font-family: 'Assistant', sans-serif;
            overflow: hidden;
            margin: 0;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            height: 100vh;
            box-sizing: border-box;
        }

        /* --- Ported Styles from net_mgmt/style.css --- */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
        }

        .stat-card {
            background: var(--surface-glass);
            border: 1px solid var(--border-glass);
            border-radius: 16px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            transition: transform 0.3s;
            backdrop-filter: blur(10px);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-cyan);
        }

        .icon-wrapper {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .icon-wrapper.cyan {
            background: rgba(6, 182, 212, 0.1);
            color: var(--primary-cyan);
        }

        .icon-wrapper.green {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-green);
        }

        .icon-wrapper.red {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-red);
        }

        .icon-wrapper.purple {
            background: rgba(139, 92, 246, 0.1);
            color: var(--accent-purple);
        }

        .stat-info h3 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
        }

        .stat-info p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0;
        }

        .glass-panel {
            background: var(--surface-glass);
            border: 1px solid var(--border-glass);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .panel-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }

        /* --- Chart Layout --- */
        .charts-container {
            flex: 1;
            display: flex;
            gap: 20px;
            min-height: 0;
            /* Important for flex child scrolling */
        }

        .chart-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            position: relative;
        }

        .chart-title {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .chart-area {
            flex: 1;
            position: relative;
            min-height: 0;
        }

        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
            border-bottom: 1px solid var(--border-glass);
            font-size: 0.85rem;
        }

        td {
            padding: 0.8rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .light-mode td {
            border-bottom-color: rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="dashboard-header">
        <h1>Dashboard</h1>
        <div class="flex items-center gap-2">
            <span id="sync-time" class="text-xs font-mono text-indigo-400 bg-indigo-500/10 px-2 py-1 rounded">Synced:
                --:--</span>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="stats-grid">
        <!-- 1. System Status -->
        <div class="stat-card">
            <div class="icon-wrapper cyan">
                <i class="fa-solid fa-server"></i>
            </div>
            <div class="stat-info">
                <h3 id="fw-status-text" class="text-lg">--</h3>
                <p>Firewall Status</p>
                <span id="fw-status-dot" class="hidden"></span> <!-- Hidden hook for JS logic -->
            </div>
        </div>

        <!-- 2. Pending Rules -->
        {% set rules_target = 'admin-approval' if session.get('is_admin') else 'my-requests' %}
        <div class="stat-card cursor-pointer" onclick="window.parent.toggleComponent('{{ rules_target }}')">
            <div class="icon-wrapper purple">
                <i class="fa-solid fa-shield-halved"></i>
            </div>
            <div class="stat-info">
                <h3 id="count-rules">0</h3>
                <p>Pending Rules</p>
            </div>
        </div>

        <!-- 3. Pending Objects -->
        {% set objects_target = 'object-approval' if session.get('is_admin') else 'my-objects' %}
        <div class="stat-card cursor-pointer" onclick="window.parent.toggleComponent('{{ objects_target }}')">
            <div class="icon-wrapper green">
                <i class="fa-solid fa-box"></i>
            </div>
            <div class="stat-info">
                <h3 id="count-objects">0</h3>
                <p>Pending Objects</p>
            </div>
        </div>

        <!-- 4. Total Traffic -->
        <div class="stat-card">
            <div class="icon-wrapper red">
                <i class="fa-solid fa-chart-line"></i>
            </div>
            <div class="stat-info">
                <h3 id="total-traffic">0</h3>
                <p>Traffic Events</p>
            </div>
        </div>
    </div>

    <!-- Main Content Panel -->
    <div class="glass-panel">
        <div class="panel-header">
            <h2>Traffic Intelligence</h2>
            <div class="flex gap-2">
                <span id="count-expiry"
                    class="text-xs text-rose-400 font-bold bg-rose-500/10 px-2 py-1 rounded hidden"></span>
            </div>
        </div>

        <div class="charts-container">
            <!-- Pie Chart: Apps -->
            <div class="chart-wrapper">
                <div class="chart-title">Top Applications</div>
                <div class="chart-area">
                    <canvas id="chart-apps"></canvas>
                </div>
            </div>

            <!-- Doughnut: Actions -->
            <div class="chart-wrapper">
                <div class="chart-title">Action Distribution</div>
                <div class="chart-area">
                    <canvas id="chart-actions"></canvas>
                </div>
            </div>

            <!-- Table: Top Talkers -->
            <div class="chart-wrapper" style="flex: 1.2;">
                <div class="chart-title" style="text-align: left; padding-left: 0.5rem;">Top Source IPs</div>
                <div class="flex-1 overflow-y-auto custom-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th>Source IP</th>
                                <th>Hits</th>
                            </tr>
                        </thead>
                        <tbody id="top-talkers-body">
                            <!-- Filled by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden elements to satisfy existing JS selectors without breaking logic -->
    <div class="hidden">
        <div id="db-val"></div>
        <div id="db-bar"></div>
        <div id="audit-list"></div>
        <div id="top-admins-list"></div>
        <div id="ops-badge"></div>
    </div>

    <!-- Dashboard Logic -->
    <script>
        // Init logic
        document.addEventListener('DOMContentLoaded', () => {
            // Initial Load
            refreshDashboard();
            // Poll every 30s
            setInterval(refreshDashboard, 30000);
        });

        async function refreshDashboard() {
            await Promise.all([
                loadOperational(),
                loadWorkQueue(),
                loadSecurity(), // Logic kept for backend calls, even if UI is simplified
                loadTraffic()
            ]);
        }

        async function loadOperational() {
            try {
                const res = await fetch('/api/dashboard/operational');
                const data = await res.json();

                // FW Status
                const txt = document.getElementById('fw-status-text');
                if (data.fw_connection) {
                    txt.innerText = "Connected";
                    txt.style.color = "var(--success-green)";
                } else {
                    txt.innerText = "Disconnected";
                    txt.style.color = "var(--danger-red)";
                }

                // Sync
                document.getElementById('sync-time').innerText = "Last Sync: " + data.last_sync;

                // DB Logic maintained for compatibility but redundant in new UI

            } catch (e) { console.error(e); }
        }

        async function loadWorkQueue() {
            try {
                const res = await fetch('/api/dashboard/work-queue');
                const data = await res.json();

                document.getElementById('count-rules').innerText = data.pending_rules;
                document.getElementById('count-objects').innerText = data.pending_objects;

                const expEl = document.getElementById('count-expiry');
                if (data.expiring_rules > 0) {
                    expEl.innerText = data.expiring_rules + " Rules Expiring Soon";
                    expEl.classList.remove('hidden');
                } else {
                    expEl.classList.add('hidden');
                }
            } catch (e) { console.error(e); }
        }

        async function loadSecurity() {
            // Can be used to populate a ticker if we decide to add it back
            // For now, just making the call to not break the API promise flow
            try {
                const res = await fetch('/api/dashboard/security');
                // No UI targets active for this in new layout
            } catch (e) { console.error(e); }
        }

        let appChart = null;
        let actionChart = null;

        async function loadTraffic() {
            try {
                const res = await fetch('/api/dashboard/traffic');
                const data = await res.json();

                // Top Sources Table
                document.getElementById('top-talkers-body').innerHTML = data.top_sources.map(s => `
                    <tr>
                        <td class="font-mono" style="color: var(--primary-cyan);">${s.ip}</td>
                        <td class="font-bold">${s.count}</td>
                    </tr>
                `).join('');

                // Charts
                if (typeof Chart === 'undefined') return;

                // 1. Top Apps (Doughnut now, to match style)
                const ctxApps = document.getElementById('chart-apps').getContext('2d');
                if (appChart) appChart.destroy();

                appChart = new Chart(ctxApps, {
                    type: 'doughnut',
                    data: {
                        labels: data.top_apps.map(a => a.name),
                        datasets: [{
                            data: data.top_apps.map(a => a.count),
                            backgroundColor: ['#6366f1', '#8b5cf6', '#ec4899', '#10b981', '#f59e0b'],
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#94a3b8',
                                    font: { size: 10, family: 'Assistant' },
                                    boxWidth: 8,
                                    usePointStyle: true
                                }
                            }
                        }
                    }
                });

                // 2. Actions (Doughnut)
                const ctxActions = document.getElementById('chart-actions').getContext('2d');
                if (actionChart) actionChart.destroy();

                const allow = data.actions['allow'] || 0;
                const deny = data.actions['deny'] || 0;
                const total = allow + deny;
                document.getElementById('total-traffic').innerText = total.toLocaleString();

                actionChart = new Chart(ctxActions, {
                    type: 'doughnut',
                    data: {
                        labels: ['Allow', 'Deny'],
                        datasets: [{
                            data: [allow, deny],
                            backgroundColor: ['#10b981', '#f43f5e'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#94a3b8',
                                    font: { size: 10, family: 'Assistant' },
                                    boxWidth: 8,
                                    usePointStyle: true
                                }
                            }
                        }
                    }
                });

            } catch (e) { console.error(e); }
        }
    </script>
</body>

</html>
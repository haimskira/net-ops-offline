<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Object</title>
    <style>
        /* 
         * NO EXTERNAL DEPENDENCIES
         * Design System: Inherited Strict Parity from "Rule Manager"
         * Core DNA: Deep Navy, Slate, Cyan Accent, Monospace Labels
         */
        :root {
            /* Palette - Dark Mode (Default) */
            --bg-primary: #020617;
            /* Deepest Navy */
            --bg-panel: #0f172a;
            /* Panel Navy */
            --bg-input: #1e293b;
            /* Slate Blue Input */
            --text-main: #f8fafc;
            /* White-ish */
            --text-muted: #94a3b8;
            /* Muted Slate */
            --accent-color: #06b6d4;
            /* Neon Cyan */
            --accent-hover: #0891b2;
            --border-color: #334155;
            /* Subtle Border */
            --success-color: #10b981;
            --danger-color: #ef4444;
            --input-height: 42px;
            --radius-md: 6px;
        }

        /* Light Mode Variables - Exact Mapping */
        body.light-mode {
            --bg-primary: #f1f5f9;
            --bg-panel: #ffffff;
            --bg-input: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border-color: #cbd5e1;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-main);
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 40px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Layout Grid --- */
        .container {
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        /* --- Header --- */
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .header-icon {
            width: 48px;
            height: 48px;
            background: rgba(6, 182, 212, 0.15);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1.5rem;
            color: var(--accent-color);
        }

        .header-icon svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .header-info h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 4px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .header-info p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-family: monospace;
        }

        /* --- Main Panel (Card) --- */
        .config-panel {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
        }

        /* --- Identity Row (Top Section) --- */
        .identity-row {
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            align-items: end;
        }

        /* --- Details Grid (Bottom Section) --- */
        .details-engine {
            display: grid;
            grid-template-columns: 1fr 1fr;
            padding: 2rem;
            gap: 2rem;
        }

        /* --- Inputs Typography & Spacing --- */
        .input-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        /* Remove margin from last child to maintain vertical balance */
        .input-group:last-child {
            margin-bottom: 0;
        }

        /* Fix for Grid Alignment: Override margin for identity row items */
        .identity-row .input-group {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-family: monospace;
            /* Technical Vibe */
        }

        /* Unified Input Styling */
        input,
        textarea,
        .custom-select {
            width: 100%;
            height: var(--input-height);
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-main);
            padding: 0 1rem;
            font-family: system-ui, monospace;
            font-size: 0.95rem;
            appearance: none;
            outline: none;
            transition: all 0.2s;
        }

        textarea {
            height: auto;
            min-height: 100px;
            padding: 0.75rem 1rem;
            resize: vertical;
        }

        input:focus,
        textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 1px var(--accent-color);
        }

        input::placeholder,
        textarea::placeholder {
            color: var(--text-muted);
            opacity: 0.5;
        }

        /* --- Custom Dropdowns (Visual Parity with Inputs) --- */
        select.hidden-native,
        select.custom-enabled {
            display: none;
        }

        .custom-select {
            padding: 0;
            /* Clear padding for inner layout */
            position: relative;
            user-select: none;
            cursor: pointer;
        }

        .select-trigger {
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            transition: border-color 0.2s;
        }

        .custom-select:hover {
            border-color: var(--text-muted);
        }

        .custom-select.open {
            border-color: var(--accent-color);
        }

        .select-trigger span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .select-arrow {
            width: 12px;
            height: 12px;
            margin-left: 10px;
            fill: var(--accent-color);
            opacity: 0.8;
            transition: transform 0.2s;
        }

        .custom-select.open .select-arrow {
            transform: rotate(180deg);
        }

        .select-options {
            position: absolute;
            top: 105%;
            left: 0;
            right: 0;
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            z-index: 100;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6), 0 2px 8px rgba(6, 182, 212, 0.15);
        }

        .custom-select.open .select-options {
            display: block;
        }

        .select-option {
            padding: 10px 1rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            /* Subtle separator */
            font-size: 0.9rem;
        }

        .light-mode .select-option {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .select-option:hover {
            background-color: rgba(6, 182, 212, 0.1);
            color: var(--accent-color);
        }

        .select-option.selected {
            color: var(--accent-color);
            font-weight: bold;
        }

        /* --- Footer --- */
        .footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border-color);
            background-color: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: flex-end;
            align-items: center;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .light-mode .footer {
            background-color: var(--bg-input);
            border-top-color: var(--border-color);
        }

        .btn-submit {
            background-color: var(--accent-color);
            color: #0b1120;
            border: none;
            height: var(--input-height);
            padding: 0 2rem;
            border-radius: var(--radius-md);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .btn-submit:hover {
            background-color: var(--accent-hover);
        }

        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-submit svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        /* --- Utilities --- */
        .hidden {
            display: none !important;
        }

        .span-full {
            grid-column: 1 / -1;
        }

        /* Flex row for side-by-side inputs (Protocol + Port) */
        .flex-row {
            display: flex;
            gap: 1rem;
        }

        .flex-1 {
            flex: 1;
        }

        /* Spinner */
        #loader {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-family: monospace;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .spin-circle {
            width: 12px;
            height: 12px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- Header Section -->
        <header class="header">
            <div class="header-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                </svg>
            </div>
            <div class="header-info">
                <h1>Create Object</h1>
                <p>Define Network & Service Objects</p>
            </div>
            <div id="loader" class="hidden" style="margin-left: auto;">
                <div class="spin-circle"></div> CONNECTING...
            </div>
        </header>

        <!-- Main Config Panel -->
        <div class="config-panel">

            <!-- Identity Section -->
            <div class="identity-row">
                <div class="input-group">
                    <label>Object Type</label>
                    <select id="obj_type" class="custom-enabled" onchange="updateUI()">
                        <option value="address">Address Object</option>
                        <option value="address-group">Address Group</option>
                        <option value="service">Service Object</option>
                        <option value="service-group">Service Group</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Name</label>
                    <input type="text" id="obj_name" placeholder="E.g. SRV-WEB-01" autocomplete="off">
                </div>
            </div>

            <!-- Details Section -->
            <div class="details-engine">

                <!-- Dynamic Input: Subtype / Protocol -->
                <div class="input-group" id="subtype_group">
                    <label id="subtype_label">Type / Subtype</label>

                    <!-- Address Subtypes -->
                    <select id="addr_type" class="custom-enabled">
                        <option value="ip-netmask">IP / Netmask (CIDR)</option>
                        <option value="ip-range">IP Range</option>
                        <option value="fqdn">FQDN (Domain)</option>
                    </select>

                    <!-- Service Protocol (Hidden by default) -->
                    <select id="svc_proto" class="custom-enabled hidden-native">
                        <option value="tcp">TCP</option>
                        <option value="udp">UDP</option>
                        <option value="sctp">SCTP</option>
                    </select>
                </div>

                <!-- Dynamic Input: Value / Members -->
                <div class="input-group" id="value_group_container">
                    <label id="value_label">Value</label>

                    <!-- Single Value Input -->
                    <input type="text" id="obj_value" placeholder="192.168.1.5/32" autocomplete="off">

                    <!-- Members Input (for Groups) -->
                    <textarea id="obj_members" class="hidden"
                        placeholder="Enter members, separated by commas...&#10;Ex: Web-Srv-01, DB-Srv-02"></textarea>
                </div>

                <div class="input-group">
                    <label>Description</label>
                    <input type="text" id="obj_desc" placeholder="Optional description..." autocomplete="off">
                </div>

                <div class="input-group">
                    <label>Tag</label>
                    <select id="tag" class="custom-enabled">
                        <option value="None">None</option>
                    </select>
                </div>
            </div>

            <!-- Footer Section -->
            <div class="footer">
                <div id="status-msg" style="margin-right: 1.5rem; font-weight: 700; color: var(--accent-color);"
                    class="hidden"></div>
                <button id="submit-btn" class="btn-submit" onclick="submitObject()">
                    CREATE OBJECT
                    <svg viewBox="0 0 24 24">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        /* --- Pure JS Custom Dropdowns (Matches Rule Manager Logic) --- */
        function initCustomDropdowns() {
            document.querySelectorAll('select.custom-enabled').forEach(native => {
                // Cleanup existing for re-runs
                if (native.nextElementSibling && native.nextElementSibling.classList.contains('custom-select')) native.nextElementSibling.remove();

                // Logic to respect 'hidden-native' class or inline style
                if ((native.style.display === 'none' && !native.classList.contains('hidden-native')) || native.classList.contains('processed')) return;

                const wrapper = document.createElement('div'); wrapper.className = 'custom-select';
                // Copy hidden state if native is hidden
                if (native.classList.contains('hidden')) wrapper.classList.add('hidden');

                const trigger = document.createElement('div'); trigger.className = 'select-trigger';
                const label = native.options[native.selectedIndex]?.text || "Select...";
                trigger.innerHTML = `<span>${label}</span><svg class="select-arrow" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>`;

                const options = document.createElement('div'); options.className = 'select-options';
                Array.from(native.options).forEach(opt => {
                    if (opt.disabled) return;
                    const item = document.createElement('div'); item.className = 'select-option';
                    item.textContent = opt.text; item.dataset.value = opt.value;
                    if (opt.selected) item.classList.add('selected');
                    item.onclick = (e) => {
                        e.stopPropagation();
                        native.value = opt.value;
                        native.dispatchEvent(new Event('change'));
                        trigger.querySelector('span').textContent = opt.text;
                        wrapper.classList.remove('open');
                        options.querySelectorAll('.select-option').forEach(el => el.classList.remove('selected'));
                        item.classList.add('selected');
                    };
                    options.appendChild(item);
                });

                trigger.onclick = (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.custom-select').forEach(c => { if (c !== wrapper) c.classList.remove('open'); });
                    wrapper.classList.toggle('open');
                };

                wrapper.appendChild(trigger); wrapper.appendChild(options);
                native.parentNode.insertBefore(wrapper, native.nextSibling);

                native.style.display = 'none';
                native.classList.add('processed');

                // Listen for sync changes
                native.addEventListener('change', () => {
                    const newLabel = native.options[native.selectedIndex]?.text;
                    if (newLabel) trigger.querySelector('span').textContent = newLabel;
                });

                // Sync Visibility: If we toggle native 'hidden', we must toggle wrapper 'hidden'
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach(m => {
                        if (m.type === 'attributes' && (m.attributeName === 'class' || m.attributeName === 'style')) {
                            if (native.classList.contains('hidden')) wrapper.classList.add('hidden');
                            else wrapper.classList.remove('hidden');
                        }
                    });
                });
                observer.observe(native, { attributes: true });
            });
        }

        /* --- Global Click Handler for Dropdowns --- */
        let globalClickHandlerAdded = false;
        function setupGlobalClickHandler() {
            if (globalClickHandlerAdded) return;
            globalClickHandlerAdded = true;

            document.addEventListener('click', (e) => {
                // Close all dropdowns unless clicking inside a custom-select
                const clickedInsideDropdown = e.target.closest('.custom-select');
                if (!clickedInsideDropdown) {
                    document.querySelectorAll('.custom-select.open').forEach(dropdown => {
                        dropdown.classList.remove('open');
                    });
                }
            });
        }

        /* --- Theme Sync Logic --- */
        function syncTheme() {
            const theme = localStorage.getItem('theme');
            if (theme === 'light') document.body.classList.add('light-mode');
            else document.body.classList.remove('light-mode');
        }
        window.addEventListener('storage', syncTheme);
        window.addEventListener('message', (event) => {
            if (event.data === 'theme-toggle' || event.data.type === 'theme-toggle') document.body.classList.toggle('light-mode');
            else if (event.data.type === 'set-theme') {
                if (event.data.theme === 'light') document.body.classList.add('light-mode');
                else document.body.classList.remove('light-mode');
            }
        });
        syncTheme();

        /* --- Init & Data Fetching --- */
        window.onload = function () {
            setupGlobalClickHandler();
            initCustomDropdowns();
            fetchTags();
            updateUI(); // Set initial state
        };

        async function fetchTags() {
            try {
                const res = await fetch('/get-params');
                const data = await res.json();
                if (data.status === 'success' && data.tags) {
                    const tagSelect = document.getElementById('tag');
                    data.tags.forEach(t => tagSelect.add(new Option(t, t)));
                    // Refresh custom dropdown options
                    document.querySelectorAll('select.custom-enabled').forEach(el => el.classList.remove('processed'));
                    document.querySelectorAll('.custom-select').forEach(el => el.remove());
                    document.querySelectorAll('select.custom-enabled').forEach(el => el.style.display = ''); // Reset display to allow init
                    initCustomDropdowns();
                }
            } catch (e) { }
        }

        /* --- UI Logic for Type Switching --- */
        function updateUI() {
            const type = document.getElementById('obj_type').value;
            const subtypeLabel = document.getElementById('subtype_label');
            const valueLabel = document.getElementById('value_label');

            const subtypeGroup = document.getElementById('subtype_group');
            const valueGroupContainer = document.getElementById('value_group_container');

            const addrType = document.getElementById('addr_type');
            const svcProto = document.getElementById('svc_proto');
            const valueInput = document.getElementById('obj_value');
            const membersInput = document.getElementById('obj_members');

            // Reset visibilities & layout
            addrType.classList.add('hidden');
            svcProto.classList.add('hidden');
            valueInput.classList.add('hidden');
            membersInput.classList.add('hidden');

            // Default Layout: reset to split columns
            subtypeGroup.classList.remove('hidden');
            valueGroupContainer.classList.remove('span-full');

            if (type === 'address') {
                subtypeLabel.textContent = "TYPE / SUBTYPE";
                addrType.classList.remove('hidden');

                valueLabel.textContent = "IP / FQDN VALUE";
                valueInput.classList.remove('hidden');
                valueInput.placeholder = "192.168.1.5/32";
            }
            else if (type === 'service') {
                subtypeLabel.textContent = "PROTOCOL";
                svcProto.classList.remove('hidden');

                valueLabel.textContent = "DESTINATION PORT";
                valueInput.classList.remove('hidden');
                valueInput.placeholder = "80, 443, 8080-8090";
            }
            else if (type.includes('group')) {
                // Group Mode: Hide Subtype column, expand Value column to full width
                subtypeGroup.classList.add('hidden');
                valueGroupContainer.classList.add('span-full');

                valueLabel.textContent = "GROUP MEMBERS";
                membersInput.classList.remove('hidden');
            }
        }

        /* --- Form Submission (Logic) --- */
        async function submitObject() {
            const btn = document.getElementById('submit-btn');
            const status = document.getElementById('status-msg');
            const type = document.getElementById('obj_type').value;

            const data = {
                type: type,
                name: document.getElementById('obj_name').value,
                description: document.getElementById('obj_desc').value,
                tag: document.getElementById('tag').value,
            };

            // Dynamic Data Collection
            if (type === 'address') {
                data.value = document.getElementById('obj_value').value;
                data.subtype = document.getElementById('addr_type').value;
            } else if (type === 'service') {
                data.value = document.getElementById('obj_value').value; // Ports
                data.protocol = document.getElementById('svc_proto').value;
            } else if (type.includes('group')) {
                // Parse members from CSV
                const membersRaw = document.getElementById('obj_members').value;
                // Convert to comma-sep string for backend if it expects that, or array?
                // Rule Manager backend usually takes string values or arrays? 
                // Creating a Request -> usually 'value' field string.
                data.value = membersRaw.split(/[\n,]+/).map(s => s.trim()).filter(s => s).join(',');
            }

            // Validation
            if (!data.name || !data.value) {
                alert("Please fill Name and Value/Members");
                return;
            }

            status.textContent = "CREATING...";
            status.classList.remove('hidden');
            status.style.color = 'var(--text-muted)';
            btn.disabled = true;

            try {
                const res = await fetch('/create-object', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
                });
                const r = await res.json();

                status.textContent = r.message.toUpperCase();
                status.style.color = (r.status === 'success') ? 'var(--success-color)' : 'var(--danger-color)';

                if (r.status === 'success') {
                    setTimeout(() => location.reload(), 2000);
                } else {
                    btn.disabled = false;
                }
            } catch (e) {
                status.textContent = "COMMUNICATION ERROR: " + e;
                status.style.color = 'var(--danger-color)';
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>